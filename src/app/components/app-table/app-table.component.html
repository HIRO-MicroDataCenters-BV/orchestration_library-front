<div>
  <!-- Header Section -->
  <div
    class="flex flex-col justify-between gap-4 sm:flex-row pb-2"
    *ngIf="showHeader"
  >
    <div>
      <input
        hlmInput
        class="w-full md:w-80"
        [placeholder]="'placeholder.search' | transloco"
        [ngModel]="_rawFilterInput()"
        (input)="_filterChanged($event)"
      />
    </div>
    <div class="flex gap-2">
      <!-- Tabs -->
      <div *ngIf="tabs.length > 0">
        <hlm-tabs [tab]="tabs[0]" class="w-full">
          <hlm-tabs-list class="w-full flex">
            <button
              *ngFor="let tab of tabs"
              class="capitalize"
              [hlmTabsTrigger]="tab"
              (click)="setFilter()"
            >
              {{ tab }}
            </button>
          </hlm-tabs-list>
        </hlm-tabs>
      </div>
      <!-- Column Visibility Toggle -->
      <div>
        <button hlmBtn variant="outline" align="end" [brnMenuTriggerFor]="menu">
          {{ 'placeholder.columns' | transloco }}
          <ng-icon hlm name="lucideChevronDown" class="ml-2" size="sm" />
        </button>
        <ng-template #menu>
          <hlm-menu class="w-32">
            @for (column of _hidableColumns(); track column.id) {
            <button
              hlmMenuItemCheckbox
              class="capitalize"
              [checked]="column.getIsVisible()"
              (click)="column.toggleVisibility()"
            >
              <hlm-menu-item-check />
              {{ column.columnDef.id }}
            </button>
            }
          </hlm-menu>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Table Container -->
  <div
    [class]="
      showHeader && showFooter
        ? 'border-border mt-4 block h-[calc(100vh-220px)] w-full overflow-auto rounded-md border'
        : 'border-border block h-full w-full overflow-auto rounded-md border'
    "
  >
    <!-- We defer the loading of the table, because tanstack manipulates the DOM with flexRender which can cause errors during SSR -->
    @defer {
    <table hlmTable class="w-full">
      <thead hlmTHead>
        @for (headerGroup of _table.getHeaderGroups(); track headerGroup.id) {
        <tr hlmTr class="border-gray-200 border-b">
          @for (header of headerGroup.headers; track header.id) {
          <th
            hlmTh
            [attr.colSpan]="header.colSpan"
            class="text-sm font-medium text-gray-500 px-4 py-2.5 text-left"
          >
            @if (!header.isPlaceholder) {
            <ng-container
              *flexRender="
                header.column.columnDef.header;
                props: header.getContext();
                let headerText
              "
            >
              <div class="capitalize font-medium">{{ headerText }}</div>
            </ng-container>
            }
          </th>
          }
        </tr>
        }
      </thead>
      <tbody hlmTBody class="w-full">
        @for (row of _table.getRowModel().rows; track row.id) {
        <tr
          hlmTr
          [attr.data-state]="row.getIsSelected() && 'selected'"
          [class.cursor-pointer]="hasRowAction"
          (click)="hasRowAction ? onRowClick(row.original) : null"
          class="border-gray-200 border-b"
        >
          @for (cell of row.getVisibleCells(); track cell.id) {
          <td hlmTd class="px-4 py-6">
            <!-- Dashboard Status Column -->
            @if (cell.column.id === 'dashboard_status') {
            <div class="flex items-center justify-center">
              <div class="text-green-600">
                <ng-icon hlm size="sm" name="lucideCircleCheck" />
              </div>
            </div>
            }

            <!-- Dashboard Info Column -->
            @else if (cell.column.id === 'dashboard_info') {
            <div class="flex flex-col">
              <p class="text-sm font-medium text-gray-900 dark:text-gray-100">
                {{ getDashboardMainText(cell.row.original) }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                {{ getDashboardSubText(cell.row.original) }}
              </p>
            </div>
            }

            <!-- Dashboard Date Column -->
            @else if (cell.column.id === 'dashboard_date') {
            <div class="flex flex-col text-right">
              <p class="text-xs text-gray-500 dark:text-gray-400">
                {{ getCreatedAtDate(cell.row.original) }}
              </p>
              <p class="text-xs text-gray-400 dark:text-gray-500">
                {{ getCreatedAtTime(cell.row.original) }}
              </p>
            </div>
            }

            <!-- Actions Column -->
            @else if (cell.column.id === 'actions') {
            <div class="flex justify-end">
              <button
                hlmBtn
                variant="ghost"
                size="sm"
                align="end"
                [brnMenuTriggerFor]="actionMenu"
                (click)="$event.stopPropagation()"
              >
                <ng-icon hlm name="lucideEllipsisVertical" size="sm" />
              </button>
              <ng-template #actionMenu>
                <hlm-menu>
                  @for (action of actions; track action) {
                  <button hlmMenuItem>
                    <ng-icon
                      hlm
                      size="sm"
                      [name]="ACTION_ICONS[action] || 'lucideInfo'"
                      class="mr-2"
                    />
                    <span class="capitalize">{{
                      action.replace('_', ' ')
                    }}</span>
                  </button>
                  }
                </hlm-menu>
              </ng-template>
            </div>
            }

            <!-- Status Column with Badge -->
            @else if (cell.column.id.includes('status')) {
            <span hlmBadge variant="secondary">
              {{ getCellValueAsString(cell.getValue()) }}
            </span>
            }

            <!-- Progress Column -->
            @else if (cell.column.id.includes('progress') ||
            cell.column.id.includes('percent')) {
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700">
                <div
                  class="h-full rounded-full bg-blue-500"
                  [style.width.%]="getCellValueAsNumber(cell.getValue())"
                ></div>
              </div>
              <span class="text-sm"
                >{{ getCellValueAsNumber(cell.getValue()) }}%</span
              >
            </div>
            }

            <!-- Date/Time Columns -->
            @else if (cell.column.id.includes('date') ||
            cell.column.id.includes('time') || cell.column.id === 'created_at'
            || cell.column.id === 'updated_at') {
            <span class="text-sm text-gray-500 dark:text-gray-400">
              {{ formatDateValue(cell.getValue()) }}
            </span>
            }

            <!-- Default Cell -->
            @else {
            <ng-container
              *flexRender="
                cell.column.columnDef.cell;
                props: cell.getContext();
                let cellContent
              "
            >
              <span class="text-sm">{{ cellContent }}</span>
            </ng-container>
            }
          </td>
          }
        </tr>
        } @empty {
        <tr hlmTr>
          <td
            hlmTd
            class="h-24 text-center"
            [attr.colspan]="_table.getAllColumns().length"
          >
            <div class="flex flex-col items-center justify-center gap-2">
              <ng-icon
                hlm
                name="lucideCircle"
                size="lg"
                class="text-gray-400"
              />
              <p class="text-sm text-gray-500">
                {{ 'placeholder.no_data' | transloco }}
              </p>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
    }
  </div>

  <!-- Footer Section -->
  <div
    class="mt-4 flex flex-col justify-between sm:flex-row sm:items-center"
    *ngIf="showFooter"
  >
    @if (_table.getRowCount() > 0) {
    <!-- Selected rows info -->
    <span class="text-sm text-muted-foreground">
      {{ _table.getSelectedRowModel().rows.length }} of
      {{ _table.getRowCount() }} row(s) selected
    </span>

    <!-- Pagination controls -->
    <div class="mt-2 flex sm:mt-0">
      <!-- Page size selector -->
      <brn-select
        class="inline-block"
        [ngModel]="_table.getState().pagination.pageSize"
        (ngModelChange)="_table.setPageSize($event); _table.resetPageIndex()"
      >
        <hlm-select-trigger class="w-15 mr-1 inline-flex h-9">
          <hlm-select-value />
        </hlm-select-trigger>
        <hlm-select-content>
          @for (size of _availablePageSizes; track size) {
          <hlm-option [value]="size">
            {{ size === 10000 ? 'All' : size }}
          </hlm-option>
          }
        </hlm-select-content>
      </brn-select>

      <!-- Navigation buttons -->
      <div class="flex space-x-1">
        <button
          size="sm"
          variant="outline"
          hlmBtn
          [disabled]="!_table.getCanPreviousPage()"
          (click)="_table.setPageIndex(0)"
        >
          {{ 'pagination.first' | transloco }}
        </button>
        <button
          size="sm"
          variant="outline"
          hlmBtn
          [disabled]="!_table.getCanPreviousPage()"
          (click)="_table.previousPage()"
        >
          {{ 'pagination.previous' | transloco }}
        </button>
        <button
          size="sm"
          variant="outline"
          hlmBtn
          [disabled]="!_table.getCanNextPage()"
          (click)="_table.nextPage()"
        >
          {{ 'pagination.next' | transloco }}
        </button>
        <button
          size="sm"
          variant="outline"
          hlmBtn
          [disabled]="!_table.getCanNextPage()"
          (click)="_table.setPageIndex(_table.getPageCount() - 1)"
        >
          {{ 'pagination.last' | transloco }}
        </button>
      </div>
    </div>
    } @else {
    <div class="flex h-full w-full items-center justify-center">
      <div class="text-muted-foreground text-sm">
        {{ 'placeholder.no_data' | transloco }}
      </div>
    </div>
    }
  </div>
</div>
